---
layout: blog
note: true
istop: true
title:  "高层火灾逃生体验 -- 详细设计文档"
tags:
- VR
- Unity
- Focus
backfround: red
background-image: https://i.loli.net/2018/09/08/5b936963946d4.jpg
date:   2018-09-03
category: VR 内容研发
---
> 为了推动消防科普教育工作，大力普及消防知识，提高全民消防安全意识和自防自救能力。本项目基于虚拟现实技术，还原真实的火灾场景，让体验者能够掌握在火灾发生时正确的应对知识和应急措施，提高体验者的应急疏散能力和路径选择能力，辅助降低火灾的伤害水平。

### 1. 引言
#### 1.1 编写目的
在前一阶段（概要设计说明书）中，已解决了实现系统需求的程序模块设计问题。包括如何把该系统划分为若干个模块、决定各个模块之间的接口、以及数据结构、模块结构的设计等。在以下的详细设计报告中将对在本阶段中系统所做的所有详细设计进行说明。

在本阶段中，确定应该如何具体地实现所要求的系统，从而在编码阶段可以把这个描述直接翻译成用具体的程序语言书写的程序。主要的工作有：根据在《需求分析说明书》中所描述的数据、功能、运行、性能需求，并依照《概要设计说明书》所确定的处理流程、总体结构和模块外部设计、设计软件系统的结构设计、逐个模块的程序描述（包括各模块的功能、性能、输入、输出、算法、程序逻辑、接口等），完成系统的详细设计。

在以下的各个阶段中，《用户操作手册》也将于本阶段的工作紧密结合，努力做到让用户易懂易学。《测试报告》也将参考本说明书，检验本系统的各项性能指标，及时发现纰漏及时修补。

#### 1.2 项目背景
为了推动消防科普教育工作，大力普及消防知识，提高全民消防安全意识和自防自救能力。本项目基于虚拟现实技术，还原真实的火灾场景，让体验者能够掌握在火灾发生时正确的应对知识和应急措施，提高体验者的应急疏散能力和路径选择能力，辅助降低火灾的伤害水平。

本项目作为北航软件学院非全日制研究生《二级工程实践》课程的开发训练项目，由温旭宏鹤团队主要负责策划、设计及开发。希望通过实战项目开发，加深学生对虚拟现实技术的认识，提高学生使用 3D 引擎开发应用程序的能力，同时训练学生了解并掌握软件文档的相关标准、编写原则以及写作技巧。

**本项目的名称**：高层火灾逃生体验系统（VR版）。  
**本项目的提出者**：北航软件学院研究生《二级工程实践》课程教师吕云。  
**本项目的开发者**：北航软件学院2017级非全日制研究生温旭宏鹤、刘毅然、姚伟莉、兰永亮。

#### 1.3 定义
##### 1.3.1 专门术语
 * Vive Focus ：HTC 于2017年11月14日发布的一款 VR一体机，采用高通骁龙835处理器和AOLED屏幕，定位方式为 inside-out ，头显为 6 自由度，配带一只 3 自由度的手柄。

##### 1.3.2 缩写
* 系统：若未特殊指出，统指本高层火灾体验系统  
* Focus：若未特殊指出，统指 VR 一体机，Vive Focus 。  

#### 1.4 参考资料
以下列出在详细设计过程中所使用到的有关资料：  
1. 《需求规格说明书》&emsp;&emsp;&nbsp; VR 软件开发小组 &emsp;&emsp;&nbsp; 2018/7  
2. 《概要设计说明书》&emsp;&emsp;&nbsp; VR 软件开发小组 &emsp;&emsp;&nbsp; 2018/7  
3. 《实用软件文档写作》 肖刚等著&emsp;&emsp;&nbsp;清华大学出版社&emsp;&emsp;2005/2   

文档所采用的标准是参照《软件工程导论》沈美明著 的“计算机软件开发文档编写指南”。

### 2. 程序系统的结构
#### 2.1 项目环境
* 开发工具：Unity 2017.2.1 ，Visual Studio 2017  
* 开发语言：C# 开发框架  
* 运行环境：本系统基于 Android 平台，安装运行于 Vive Focus 上。

#### 2.2 系统组织结构
本系统分为三个部分：新手引导、进入系统、退出系统。其中主要部分“进入系统”分为四大模块：主逻辑模块、UI 模块、音频模块、控制器模块。主逻辑模块负责管理和切换系统逻辑进程，管理和调配系统资源。UI 模块负责加载和管理系统的所有 UI 资源，并且为 UI 中的按钮添加相应的点击事件。音频模块主要负责加载和分类管理系统中所有的音频资源，包括背景音乐、音效、语音讲解等音频。控制器模块主要负责手柄控制器相关的功能，包括监听手柄按键输入事件，进行射线检测、碰撞检测等，以及对手柄交互添加相应的响应事件。系统组织结构如图 1 所示。

```
graph TD
A[高层火灾逃生体验系统]-->B[新手引导]
A --> B1[进入系统]
A --> B2[退出系统]
B1 --> C0[主逻辑模块]
B1 --> C1[UI 模块]
B1 --> C2[音频模块]
B1 --> C3[控制器模块]
C0 --> D01[管理切换系统进程]
C0 --> D02[管理调配系统资源]
C1 --> D11[加载管理 UI 资源]
C1 --> D12[为 UI 按钮添加响应事件]
C2 --> D21[加载管理音频资源]
C3 --> D31[监听Focus手柄事件]
C3 --> D32[为手柄交互添加响应事件]
```
<center>图1 系统组织结构图</center>

### 3. 程序设计说明
本章主要就 “进入系统” 部分的四大模块：主逻辑模块、 UI 模块、音频模块、控制器模块进行详细说明。

#### 3.1 主逻辑模块
##### （1）场景加载及初始化
**程序描述**：场景加载及初始化  
**功能描述**：加载并获取场景中的物体，包括模型、动画、脚本等，并对其进行初始化。  
**接口描述**：见表 1

<html>
<center>表1 场景加载及初始化</center>
<!--在这里插入内容-->
<table align = "center">
    <tr>
        <td>执行条件</td>
        <td width="90%">需要加载的资源存在，且路径及名字书写正确</td>
    </tr>
    <tr>
        <td>属性</td>
        <td>public GameObject _gEventRoot; // 场景中模型根目录<br>
            public GameObject _gUIRoot; // 场景中 UI 根目录<br>
            模型、动画、脚本
        </td>
    </tr>
    <tr>
        <td>方法</td>
        <td>void Start(); // 场景加载，获取场景中的物体<br>
            void Init();  // 场景初始化
        </td>
    </tr>
</table>
</html>

##### （2）进程管理与切换
**程序描述**：进程管理与切换  
**功能描述**：本系统中，主要靠体验者的位置来控制进程。靠体验者移动位置来切换进程。  
**接口描述**：

```
public void ChangeState()
{
    // m_nCurTransID    ：当前进程状态
    // m_nPosCount      ：总进程数
    if (m_nCurTransID >= m_nPosCount)
    {
        return;
    }

    if (m_nCurTransID == 0)  
    {
        // Do Something
    }
    else if (m_nCurTransID == 1)  
    {
        // Do Something
    }
    else if (m_nCurTransID == 2)  
    {
        // Do Something
    }
    ...
    else if(m_nCurTransID == m_nPosCount)
    {
        // Do Something
    }
}
```

##### （3）按钮点击响应事件
**程序描述**：按钮点击响应事件  
**功能描述**：由于场景中的模型、动画等资源仅在主逻辑脚本中获得，故点击 UI 按钮时，调用此处的按钮点击响应事件函数。  
**接口描述**：


- UIMain.cs
```
public void UIConfirmBtnClicked(string sName)       //点击按钮
{
    int nIndex = GetIdByName(sName);
    if(nIndex == 0)
    {
        //退出应用
        m_gameMain.QuitApp();
    }
    else if(nIndex == 1)
    {
        //取消退出
        m_gameMain.CancelQuit();
    }
    else if(nIndex == 2)
    {
        //开始进入火灾体验
        m_gameMain.StartGame();
    }
    else if(nIndex == 3)
    {
        //选择其他逃生通道
        m_gameMain.FindOtherWay();
    }
    else if (nIndex == 4)
    {
        //选择其他房间
        m_gameMain.ToAnotherRoom();
    }
    else if (nIndex == 5)
    {
        //重新进入火灾体验
        m_gameMain.RestartGame();
    }
}
```
- GameMain.cs
```
public void QuitApp()
{
    //退出应用
}
public void CancelQuit()
{
    //取消退出
}
public void StartGame()
{
    //开始进入火灾体验
}
public void RestartGame()
{
    //重新进入火灾体验
}
public void FindOtherWay()
{
    //选择其他逃生通道
}
public void ToAnotherRoom()
{
    //选择其他房间
}
```

##### （4）物体点击响应事件
**程序描述**：物体点击响应事件  
**功能描述**：由于场景中的模型、动画等资源仅在主逻辑脚本中获得，故点击可交互物体时，调用此处的点击响应事件函数。   
**接口描述**：  

- ControllerManager.cs
```
//碰撞检测
GameObject hititem = m_Pointer.GetHitTrans().gameObject;
//点击按钮
if (WaveVR_Controller.Input(WVR_DeviceType.WVR_DeviceType_Controller_Right).GetPressDown(WVR_InputId.WVR_InputId_Alias1_Touchpad))
{
    //点击按钮
    if (hititem.name.Contains("Button"))
    {
        m_main.OnConfirmBtnClicked(hititem.name);
    }
    //点击水龙头
    if (hititem.name.Equals("watertap"))
    {
        m_main.OnWaterTapClicked();
    }
    //点击毛巾
    if (hititem.name.Equals("towel"))
    {
        m_main.OnTowelClicked();
    }
    //点击安全通道门
    if (hititem.name.Equals("SafeDoor"))
    {
        m_main.OnDoorClicked();
    }
    //点击胶带
    if (hititem.name.Equals("tape"))
    {
        m_main.OnTapeStick();
    }
    //点击手电
    if (hititem.name.Equals("torch"))
    {
        m_main.OnPickUpTorch();
    }
}
```
- GameMain.cs
```
public void OnConfirmBtnClicked(string name)
{
    //点击按钮
}
public void OnWaterTapClicked()
{
    //点击水龙头
}
public void OnTowelClicked()
{
    //点击毛巾
}
public void OnDoorClicked()
{
    //点击安全通道门
}
public void OnTapeStick()
{
    //点击胶带
}
public void OnPickUpTorch()
{
    //点击手电
}
```

#### 3.2 UI 模块
##### （1）加载资源
**程序描述**：加载 UI 资源  
**功能描述**：获取场景中所有的 Canvas ，以及 Resources 中需要动态加载的贴图等。  
**接口描述**：见表 2

<html>
<center>表2 加载资源</center>
<!--在这里插入内容-->
<table align = "center">
    <tr>
        <td>执行条件</td>
        <td width="90%">需要加载的 UI 资源存在，且路径及名字书写正确</td>
    </tr>
    <tr>
        <td>属性</td>
        <td> public GameObject _gUIRoot; // 场景中 UI 根目录<br>public GameObject _gHeadUIRoot; // 挂载在头部的 UI 根目录</td>
    </tr>
    <tr>
        <td>方法</td>
        <td>void LoadUI(); // 通过 UI 的根目录，获取所有的 UI 资源</td>
    </tr>
</table>
</html>

##### （2）初始化
**程序描述**：初始化 UI 状态  
**功能描述**：显示初始状态下需要显示的 UI，隐藏不需要显示的 UI 。并为 UI 的按钮添加响应事件。  
**接口描述**：见表 3

<html>
<center>表3 初始化 UI 状态</center>
<!--在这里插入内容-->
<table align = "center">
    <tr>
        <td>执行条件</td>
        <td width="90%">所有的 UI 资源被正确的加载</td>
    </tr>
    <tr>
        <td>属性</td>
        <td> public GameObject _gUIRoot; // 场景中 UI 根目录<br>public GameObject _gHeadUIRoot; // 挂载在头部的 UI 根目录</td>
    </tr>
    <tr>
        <td>方法</td>
        <td>void InitUI(); // 初始化 UI 状态</td>
    </tr>
</table>
</html>

##### （3）添加响应事件
**程序描述**：为 UI 中的按钮添加点击响应事件  
**功能描述**：获取 UI 中的所有按钮，并为其添加响应事件  
**接口描述**：见表 4

<html>
<center>表4 初始化 UI 状态</center>
<!--在这里插入内容-->
<table align = "center">
    <tr>
        <td>执行条件</td>
        <td width="90%"> UI 按钮被正确的加载</td>
    </tr>
    <tr>
        <td>属性</td>
        <td> private Button[] m_btns; // 场景中的所有 UI 按钮</td>
    </tr>
    <tr>
        <td>方法</td>
        <td>void InitUI(); // 为 UI 按钮添加点击响应事件</td>
    </tr>
</table>
</html>

##### （4）显示/隐藏 UI 界面
**程序描述**：显示/隐藏 UI 界面  
**功能描述**：显示或隐藏某一个 UI 界面  
**接口描述**：见表 5

<html>
<center>表5 显示/隐藏 UI 界面</center>
<!--在这里插入内容-->
<table align = "center">
    <tr>
        <td>执行条件</td>
        <td width="90%">所有的 UI 界面被正确的加载</td>
    </tr>
    <tr>
        <td>参数</td>
        <td> nIndex : 场景中 UI Panel 的序号<br>bShow : 为 true 时显示，为 false 时隐藏。</td>
    </tr>
    <tr>
        <td>方法</td>
        <td>public void ShowPanel(int nIndex, bool bShow);</td>
    </tr>
</table>
</html>

##### （5）隐藏所有 UI 界面
**程序描述**：隐藏所有 UI 界面  
**功能描述**：隐藏所有 UI 界面，用作初始化场景  
**接口描述**：见表 6

<html>
<center>表6 隐藏所有 UI 界面</center>
<!--在这里插入内容-->
<table align = "center">
    <tr>
        <td>执行条件</td>
        <td width="90%">所有的 UI 界面被正确的加载</td>
    </tr>
    <tr>
        <td>属性</td>
        <td> public GameObject _gUIRoot; // 场景中 UI 根目录<br>public GameObject _gHeadUIRoot; // 挂载在头部的 UI 根目录</td>
    </tr>
    <tr>
        <td>方法</td>
        <td>public void HideAllPanels(); </td>
    </tr>
</table>
</html>

##### （6）UI 按钮响应事件
**程序描述**：UI 按钮响应事件函数  
**功能描述**：包括手柄射线移入时的事件，和手柄射线点击事件  
**接口描述**：见表 7

<html>
<center>表7 UI 按钮响应事件</center>
<!--在这里插入内容-->
<table align = "center">
    <tr>
        <td>执行条件</td>
        <td width="90%">UI 按钮被正确的加载</td>
    </tr>
    <tr>
        <td>属性</td>
        <td> private Button[] m_btns; // 场景中的所有 UI 按钮</td>
    </tr>
    <tr>
        <td>方法</td>
        <td>public void OnPointerInBtn(RayPointerArgs e); // 射线移入事件<br>public void UIConfirmBtnClicked(string sName); // 点击事件，sName 为按钮名称</td>
    </tr>
</table>
</html>


#### 3.3 音频模块
##### （1）加载资源
**程序描述**：加载音频资源  
**功能描述**：获取场景中所有的 AudioPlayer，以及 Resources 中需要动态加载的音频文件等。  
**接口描述**：见表 8

<html>
<center>表8 加载资源</center>
<!--在这里插入内容-->
<table align = "center">
    <tr>
        <td>执行条件</td>
        <td width="90%">需要加载的 AudioClip 及 AudioPlayer 存在，且路径及名字书写正确</td>
    </tr>
    <tr>
        <td>属性</td>
        <td>private AudioClip[] m_voiceClips; // 语音讲解的音频文件<br> 
            private AudioClip[] m_bgmClips; // 背景声音的音频文件<br>
            private AudioSource m_voiceAudio; // 语音讲解播放器<br>
            private AudioSource m_effectAudio; // 音效播放器<br>
            private AudioSource m_CoughSound; // 咳嗽声音播放器<br>
            private AudioSource m_warningAudio; // 警报声音播放器<br>
            private AudioSource m_bgmAudio; // 背景音乐播放器<br>
        </td>
    </tr>
    <tr>
        <td>方法</td>
        <td>void LoadAudio(); // 获取所有的 AudioClip 和 AudioPlayer</td>
    </tr>
</table>
</html>

##### （2）初始化
**程序描述**：初始化音频播放器状态  
**功能描述**：为 AudioPlayer 装载相应的音频文件，并播放初始场景中需要的音频。  
**接口描述**：见表 9

<html>
<center>表9 初始化音频播放器状态</center>
<!--在这里插入内容-->
<table align = "center">
    <tr>
        <td>执行条件</td>
        <td width="90%">所有的 Audio Clip 资源和 Audio Player 被正确的加载</td>
    </tr>
    <tr>
        <td>属性</td>
        <td>private AudioClip[] m_voiceClips; // 语音讲解的音频文件<br> 
            private AudioClip[] m_bgmClips; // 背景声音的音频文件<br>
            private AudioSource m_voiceAudio; // 语音讲解播放器<br>
            private AudioSource m_effectAudio; // 音效播放器<br>
            private AudioSource m_CoughSound; // 咳嗽声音播放器<br>
            private AudioSource m_warningAudio; // 警报声音播放器<br>
            private AudioSource m_bgmAudio; // 背景音乐播放器<br>
        </td>
    </tr>
    <tr>
        <td>方法</td>
        <td>void InitAudio(); // 初始化音频播放器状态</td>
    </tr>
</table>
</html>

##### （3）播放音频
**程序描述**：播放音频  
**功能描述**：为音频文件分类，通过不同的函数，调用不同的播放器，播放不同类别的音频。  
**接口描述**：见表 10

<html>
<center>表10 播放音频</center>
<!--在这里插入内容-->
<table align = "center">
    <tr>
        <td>执行条件</td>
        <td width="90%">所有的 Audio Clip 资源和 Audio Player 被正确的加载</td>
    </tr>
    <tr>
        <td>属性</td>
        <td>private AudioClip[] m_voiceClips; // 语音讲解的音频文件<br> 
            private AudioClip[] m_bgmClips; // 背景声音的音频文件<br>
            private AudioSource m_voiceAudio; // 语音讲解播放器<br>
            private AudioSource m_effectAudio; // 音效播放器<br>
            private AudioSource m_CoughSound; // 咳嗽声音播放器<br>
            private AudioSource m_warningAudio; // 警报声音播放器<br>
            private AudioSource m_bgmAudio; // 背景音乐播放器<br>
        </td>
    </tr>
    <tr>
        <td>方法</td>
        <td>public void PlayVoice(int nIndex)； // 播放语音讲解词，nIndex 为语音音频序号<br>
            public void PlayEffectAudio(int nIndex)； // 播放音效，nIndex 为音效音频序号<br>
            public void PlayBgm()；// 播放背景音乐（火灾时大火燃烧声音）<br>
            public void PlayWarningAudio()；// 播放警报声（消防车，警铃声，人群惊呼声）<br>
            public void PlayCoughSound()；// 播放咳嗽声（被烟雾呛到）<br>
        </td>
    </tr>
</table>
</html>

##### （4）停止所有音频
**程序描述**：停止所有音频  
**功能描述**：停止播放所有音频，作初始化场景时用。  
**接口描述**：见表 11

<html>
<center>表11 停止所有音频</center>
<!--在这里插入内容-->
<table align = "center">
    <tr>
        <td>执行条件</td>
        <td width="90%">所有的 Audio Clip 资源和 Audio Player 被正确的加载</td>
    </tr>
    <tr>
        <td>属性</td>
        <td>private AudioSource m_voiceAudio; // 语音讲解播放器<br>
            private AudioSource m_effectAudio; // 音效播放器<br>
            private AudioSource m_CoughSound; // 咳嗽声音播放器<br>
            private AudioSource m_warningAudio; // 警报声音播放器<br>
            private AudioSource m_bgmAudio; // 背景音乐播放器<br>
        </td>
    </tr>
    <tr>
        <td>方法</td>
        <td>public void StopAllAudio(); // 停止播放所有音频
        </td>
    </tr>
</table>
</html>

#### 3.4 控制器模块
##### （1）控制器按键检测
**程序描述**：控制器按键检测  
**功能描述**：监听控制器的扳机键、圆盘键、用户菜单键的点击事件  
**接口描述**：

```
if (WaveVR_Controller.Input(WVR_DeviceType.WVR_DeviceType_Controller_Right).GetPressDown(WVR_InputId.WVR_InputId_Alias1_Menu))
{
    //用户菜单点击事件
}
if (WaveVR_Controller.Input(WVR_DeviceType.WVR_DeviceType_Controller_Right).GetPressDown(WVR_InputId.WVR_InputId_Alias1_Bumper))
{
    //扳机键点击事件
}
if (WaveVR_Controller.Input(WVR_DeviceType.WVR_DeviceType_Controller_Right).GetPressDown(WVR_InputId.WVR_InputId_Alias1_Touchpad))
{
    //圆盘键点击事件
}
```

##### （2）射线检测
**程序描述**：射线检测  
**功能描述**：检测手柄射线指到的物体，并且在指到特定物体时触发响应事件。  
**接口描述**：

```
//首先获取手柄（射线从手柄发出）
WaveVR_SimplePointer m_Pointer;
m_Pointer = transform.GetComponentInChildren<WaveVR_SimplePointer>();

//射线检测
GameObject hititem = m_Pointer.GetHitTrans().gameObject;
if (hititem.name == "ObjectName1")
{
    // Do Something When Raycaster hit ObjectName1
}
else if(hititem.name == "ObjectName2")
{
    // Do Something When Raycaster hit ObjectName2
}
```

### 4. 测试计划

1. 测试运行过程中帧率是否满足要求，即视野两侧有无明显黑框。
1. 测试音频、动画是否能正确播放。
2. 测试 UI 按钮是否能正确的触发响应事件。
3. 测试程序的退出菜单是否随时随地呼出/隐藏，以及退出系统。
4. 测试在体验过程中，系统能否正确判断人的身体姿态（下蹲还是站立）。
5. 测试程序运行结束后重新开始时，是否所有物体处于正确的初始化状态。
6. 测试在非常规操作下，程序能否依旧正确地执行。
1. 测试程序整个流程中，是否覆盖需求中的所有知识点。
2. 测试在体验过程中，系统是否存在一些细节传达了错误的知识点。
1. 测试在无任何旁人提示下，体验者能否注意到所有的提示信息。
2. 测试在无任何旁人提示下，体验者能否独立操作完成全部流程。
3. 测试在体验过程中，是否存在比例不协调，与周围环境违和的物体。
4. 测试在体验过程中，是否存在违反人体工程学的交互操作。